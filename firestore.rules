
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Validates a Task document
    function isValidTask(task) {
      return task.keys().hasAll(['id', 'boardId', 'title', 'completed']) &&
             task.title is string &&
             task.completed is bool &&
             (task.get('size', 60) is number);
    }
    
    // Validates a Board document
    function isValidBoard(board) {
      return board.keys().hasAll(['id', 'name']) &&
             board.name is string &&
             board.name.size() > 0 &&
             board.name.size() < 50;
    }

    match /users/{userId} {
       allow read, write: if request.auth != null && request.auth.uid == userId;

       match /tasks/{taskId} {
         allow read: if request.auth != null && request.auth.uid == userId;
         allow write: if request.auth != null && request.auth.uid == userId && 
                      (request.resource.data == null || isValidTask(request.resource.data));
       }
       
       match /boards/{boardId} {
         allow read: if request.auth != null && request.auth.uid == userId;
         allow write: if request.auth != null && request.auth.uid == userId &&
                      (request.resource.data == null || isValidBoard(request.resource.data));
       }
       
       match /settings/{settingId} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
       }
    }
  }
}
